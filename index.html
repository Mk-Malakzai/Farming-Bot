<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>USDT FARMING</title>
    <link rel="icon" href="https://i.ibb.co/GfSXrc6X/1758858256731.png" type="image/jpeg">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <style>
        /* --- Global Styles & Dark Theme --- */
        :root {
            --bg-color: #121212;
            --primary-surface: #1e1e1e;
            --secondary-surface: #2a2a2a;
            --primary-accent: #f0b90b;
            --secondary-accent: #4caf50;
            --primary-text: #ffffff;
            --secondary-text: #b0b0b0;
            --danger-color: #f44336;
            --font-family: 'Helvetica Neue', Arial, sans-serif;
        }
* {
  -webkit-tap-highlight-color: transparent;
}

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--primary-text);
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .hidden { display: none !important; }
        /* --- Loader --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); display: flex; justify-content: center;
            align-items: center; z-index: 9999; font-size: 1.5em;
        }
        /* --- Main App Container --- */
        #app-container {
            display: flex; flex-direction: column; height: 100%; width: 100%;
        }
        /* --- Header --- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; background-color: var(--primary-surface);
            border-bottom: 1px solid var(--secondary-surface);
        }
        .profile-info { display: flex; align-items: center; gap: 10px; }
        .profile-pic { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .coin-balance { font-size: 1.2em; font-weight: bold; }
        /* --- Main Content --- */
        .main-content {
            flex-grow: 1; overflow-y: auto; padding: 15px; position: relative;
        }
        .tab-content { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* --- Farming Tab --- */
        #farming-tab {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; height: 100%; gap: 20px;
        }
        #logo-container { position: relative; }
        .farm-logo {
            width: 150px; height: 150px; border-radius: 50%;
            border: 5px solid var(--primary-accent); box-shadow: 0 0 20px var(--primary-accent);
        }
        .progress-bar-container {
            width: 80%; background-color: var(--secondary-surface); border-radius: 10px; padding: 3px;
        }
        .progress-bar {
            width: 0%; height: 10px; background-color: var(--secondary-accent);
            border-radius: 8px; transition: width 1s linear;
        }
        #farm-timer { font-size: 1.1em; color: var(--secondary-text); }
        #farm-button {
            padding: 15px 40px; font-size: 1.2em; font-weight: bold; border: none;
            border-radius: 12px; background-color: var(--primary-accent);
            color: var(--bg-color); cursor: pointer; transition: transform 0.2s;
        }
        #farm-button:disabled {
            background-color: var(--secondary-surface); color: var(--secondary-text); cursor: not-allowed;
        }
        #farm-button:active { transform: scale(0.95); }
        /* --- Falling Leaves Animation --- */
        #falling-leaves-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; pointer-events: none; z-index: -1;
        }
        .leaf {
            position: absolute; top: -10%; font-size: 1.5em; animation: fall linear infinite;
        }
        @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }
        /* --- Level Up Popup --- */
        #level-up-popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.5);
            background: var(--primary-surface); padding: 40px; border-radius: 20px;
            text-align: center; z-index: 1000; border: 2px solid var(--primary-accent);
            opacity: 0; transition: opacity 0.3s, transform 0.3s; pointer-events: none;
        }
        #level-up-popup.show {
            opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: all;
        }
        #confetti-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; pointer-events: none;
        }
        /* --- General Task/List Styles --- */
        .task-list, .history-list { display: flex; flex-direction: column; gap: 10px; }
        .task-item, .history-item {
            background: var(--primary-surface); padding: 15px; border-radius: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .task-info, .history-info { flex-grow: 1; }
        .task-item button, .form-container button, .admin-section button {
            padding: 8px 15px; background: var(--primary-accent); color: var(--bg-color);
            border: none; border-radius: 8px; cursor: pointer; font-weight: bold;
        }
        .task-item button:disabled { background: var(--secondary-surface); color: var(--secondary-text); }
        .form-container { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .form-container input, .form-container select {
            padding: 12px; border-radius: 8px; border: 1px solid var(--secondary-surface);
            background-color: var(--bg-color); color: var(--primary-text); font-size: 1em;
        }
        /* --- Navigation Bar --- */
        .nav-bar {
            display: flex; justify-content: space-around; background-color: var(--primary-surface);
            padding: 10px 0; border-top: 1px solid var(--secondary-surface);
        }
        .nav-item {
            cursor: pointer; padding: 5px 15px; opacity: 0.7;
            transition: opacity 0.2s, transform 0.2s; text-align: center;
        }
        .nav-item.active { opacity: 1; transform: scale(1.1); color: var(--primary-accent); }
        /* --- Admin Panel --- */
        #admin-panel {
            padding: 20px; background: #1c1c1e; color: #f5f5f7; height: 100vh; overflow-y: auto;
        }
        #admin-login-screen {
            display: flex; justify-content: center; align-items: center; height: 100vh;
        }
        .login-box {
            background: #2c2c2e; padding: 30px; border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4); text-align: center;
        }
        .login-box input {
            display: block; width: calc(100% - 20px); padding: 10px; margin: 10px auto;
            border: 1px solid #444; border-radius: 5px; background: #3a3a3c; color: #f5f5f7;
        }
        .login-box button {
            width: 100%; padding: 10px; background: #0a84ff; color: white;
            border: none; border-radius: 5px; cursor: pointer;
        }
        .admin-section {
            background: #2c2c2e; padding: 20px; margin-bottom: 20px;
            border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .admin-section h3 { margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .admin-section input, .admin-section select, .admin-section textarea {
            width: calc(100% - 20px); padding: 8px; margin-top: 5px;
            background: #3a3a3c; color: #f5f5f7; border: 1px solid #444; border-radius: 4px;
        }
        .admin-section label { display: block; margin-top: 10px; font-size: 0.9em; color: #aaa; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .admin-table th, .admin-table td {
            border: 1px solid #444; padding: 8px; text-align: left;
        }
        .admin-table th { background: #3a3a3c; }
        .admin-table button { padding: 5px 10px; font-size: 0.9em; margin-right: 5px; }
        .stat-card-container { display: flex; gap: 15px; flex-wrap: wrap; }
        .stat-card {
            flex-grow: 1; background: #3a3a3c; padding: 15px; border-radius: 8px; text-align: center;
        }
        .stat-card h4 { margin: 0 0 5px 0; color: #aaa; }
        .stat-card p { margin: 0; font-size: 1.5em; font-weight: bold; }
    </style>
</head>
<body>
    <div id="loader">Loading... üí∞</div>
    <div id="app-container" class="hidden">
        <header class="header">
            <div id="coin-balance-container" class="coin-balance">üí∞ 0</div>
            <div class="profile-info">
                <span id="user-name">User</span>
                <img id="user-pic" class="profile-pic" src="https://t.me/i/userpic/320/1.jpg" alt="P">
            </div>
        </header>
        <main class="main-content">
            <div id="farming-tab" class="tab-content">
                 <div id="falling-leaves-container"></div>
                <h2>USDT FARMING</h2>
                <div id="logo-container">
                    <img src="https://i.ibb.co/GfSXrc6X/1758858256731.png" alt="Crypto Farm Logo" class="farm-logo">
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="farm-progress"></div>
                </div>
                <span id="farm-timer">Ready to farm!</span>
                <button id="farm-button">Start Farming</button>
            </div>
            <div id="tasks-tab" class="tab-content hidden">
                <h2>Complete Tasks for Rewards</h2>
                <div id="task-list-dynamic" class="task-list">
                    </div>
            </div>
            <div id="referral-tab" class="tab-content hidden">
                 <h2>Refer & Earn</h2>
                <div class="form-container">
                    <p>Share your link! You earn 100 üí∞ for every friend who joins.</p>
                    <input type="text" id="referral-link" readonly>
                    <button onclick="copyReferralLink()">Copy Link</button>
                </div>
                 <h3>Your Referrals</h3>
                <div id="referral-history-list" class="history-list">
                    <p>No referrals yet.</p>
                </div>
            </div>
            <div id="exchange-tab" class="tab-content hidden">
                <h2>Exchange & Withdraw</h2>
                <div class="form-container">
                    <h4>Convert Coins</h4>
                    <p id="conversion-rate">Loading rate...</p>
                    <input type="number" id="convert-amount" placeholder="Enter coin amount">
                    <button onclick="convertCoins()">Convert</button>
                    <h4 style="margin-top: 20px;">Request Withdrawal</h4>
                    <select id="withdrawal-method">
                        <option value="Binance">Binance UID</option>
                        <option value="usdt">USDT (TRC20)</option>
                    </select>
                    <input type="text" id="withdrawal-address" placeholder="Enter BINANCE UID or USDT Address">
                    <input type="number" id="withdrawal-amount" placeholder="Enter USDT amount">
                    <button onclick="requestWithdrawal()">Request</button>
                </div>
                <h3>Withdrawal History</h3>
                 <div id="withdrawal-history-list" class="history-list">
                     <p>No withdrawal history.</p>
                 </div>
            </div>
            <div id="profile-tab" class="tab-content hidden">
                <h2>My Profile</h2>
                <div class="task-list">
                    <div class="task-item"><span>User ID</span> <strong id="profile-userid">...</strong></div>
                    <div class="task-item"><span>Total Coins</span> <strong id="profile-coins">...</strong></div>
                    <div class="task-item"><span>Total Exchanged (USDT)</span> <strong id="profile-exchanged">...</strong></div>
                    <div class="task-item"><span>Referrals</span> <strong id="profile-referrals">...</strong></div>
                    <div class="task-item"><span>Current Level</span> <strong id="profile-level">...</strong></div>
                </div>
            </div>
        </main>
        <nav class="nav-bar">
            <div class="nav-item active" data-tab="farming-tab">üè†<br>Farm</div>
            <div class="nav-item" data-tab="tasks-tab">üìã<br>Tasks</div>
            <div class="nav-item" data-tab="referral-tab">üë•<br>Refer</div>
            <div class="nav-item" data-tab="exchange-tab">üí∏<br>Exchange</div>
            <div class="nav-item" data-tab="profile-tab">üë§<br>Profile</div>
        </nav>
        <div id="level-up-popup">
            <div id="confetti-container"></div>
            <h2>LEVEL UP!</h2>
            <p>You've reached <strong id="new-level">Level X</strong>!</p>
            <p>üéâ Rewards Unlocked! üéâ</p>
        </div>
    </div>
    <div id="admin-panel" class="hidden">
        <div id="admin-login-screen">
            <div class="login-box">
                <h2>USDT FARMING - Admin Login</h2>
                <input type="email" id="admin-email" placeholder="Email" value="admin@gmail.com">
                <input type="password" id="admin-password" placeholder="Password" value="admin123">
                <button onclick="handleAdminLogin()">Login</button>
                <p id="admin-login-error" style="color:red;"></p>
            </div>
        </div>
        <div id="admin-dashboard" class="hidden">
            <h2>Admin Dashboard</h2>
            <div class="admin-section">
                <h3>Dashboard Stats</h3>
                <div class="stat-card-container">
                    <div class="stat-card"><h4>Total Users</h4><p id="stats-total-users">0</p></div>
                    <div class="stat-card"><h4>Total Coins in Circulation</h4><p id="stats-total-coins">0</p></div>
                    <div class="stat-card"><h4>Pending Withdrawals</h4><p id="stats-pending-withdrawals">0</p></div>
                </div>
            </div>
            <div class="admin-section">
                <h3>Task Management</h3>
                <input type="hidden" id="task-id-input">
                <label>Task Name</label><input type="text" id="task-name-input" placeholder="e.g., Join Our Community">
                <label>Task Reward (Coins)</label><input type="number" id="task-reward-input" placeholder="e.g., 200">
                <label>Task Type</label>
                <select id="task-type-input">
                    <option value="visit_link">Visit Link</option>
                    <option value="join_channel">Join Telegram Channel</option>
                    <option value="join_group">Join Telegram Group</option>
                    <option value="youtube_video">YouTube Video (with key)</option>
                </select>
                <label>Task Link (URL)</label><input type="url" id="task-link-input" placeholder="https://t.me/channel or https://youtu.be/...">
                <div id="task-key-container" class="hidden">
                    <label>YouTube Secret Key</label><input type="text" id="task-key-input" placeholder="e.g., SECRET123">
                </div>
                <button onclick="saveAdminTask()" style="margin-top:15px;">Save Task</button>
                <h4 style="margin-top: 20px;">Existing Tasks</h4>
                <table id="tasks-table" class="admin-table">
                    <thead><tr><th>Name</th><th>Reward</th><th>Type</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="admin-section">
                <h3>Global Settings</h3>
                <label>Farming Rate (coins/min):</label><input type="number" id="setting-farm-rate">
                <label>Conversion Rate (Coins per 1 USDT):</label><input type="number" id="setting-conversion-rate">
                <label>Watch Ad Reward:</label><input type="number" id="setting-ad-reward">
                <br><br>
                <button onclick="saveAdminSettings()">Save Settings</button>
            </div>
            <div class="admin-section">
                <h3>Withdrawal Requests</h3>
                <table id="withdrawal-requests-table" class="admin-table">
                    <thead><tr><th>User ID</th><th>Amount</th><th>Method</th><th>Address</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
             <div class="admin-section">
                <h3>Broadcast Message</h3>
                <textarea id="broadcast-message" rows="4"></textarea>
                <button onclick="sendBroadcast()">Send to All Users</button>
            </div>
        </div>
    </div>
    <script>
    // --- JAVASCRIPT LOGIC --- //
    document.addEventListener('DOMContentLoaded', () => {
        // --- Firebase Configuration --- //
 const firebaseConfig = {
  apiKey: "AIzaSyDGd3moIg_XSgJ9d8fYsPiOq518YdC3ADU",
  authDomain: "farming-bot-7b222.firebaseapp.com",
  projectId: "farming-bot-7b222",
  storageBucket: "farming-bot-7b222.firebasestorage.app",
  messagingSenderId: "448262746119",
  appId: "1:448262746119:web:c33f0ed34054d83c1c7aa2"
};
        // --- Firebase Initialization --- //
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (e) {
            console.error("Firebase initialization failed. Make sure you have pasted your config object.", e);
            document.getElementById('loader').innerText = "Firebase Config Missing!";
            return;
        }
        const db = firebase.firestore();
        const tg = window.Telegram.WebApp;

        // --- Global Variables --- //
        let currentUser = null;
        let userData = null;
        let farmInterval = null;
        let globalSettings = {};

            async function initializeApp() {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                tg.ready();
                tg.expand();
                currentUser = tg.initDataUnsafe.user;
                document.getElementById('app-container').classList.remove('hidden');
                await initUserPanel();
            } else {
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('admin-login-screen').classList.remove('hidden');
            }
            document.getElementById('loader').classList.add('hidden');
        }

        // --- USER PANEL LOGIC --- //
        async function initUserPanel() {
            document.getElementById('user-name').innerText = currentUser.first_name;
            if (currentUser.photo_url) {
                document.getElementById('user-pic').src = currentUser.photo_url;
            }
            await loadGlobalSettings();
            await loadUserData();
            setupEventListeners();
        }

        async function loadGlobalSettings() {
            const doc = await db.collection('settings').doc('global').get();
            if (doc.exists) {
                globalSettings = doc.data();
                document.getElementById('conversion-rate').innerText = `Rate: ${globalSettings.conversionRate || 1000} üí∞ = 1 USDT`;
            }
        }

        async function loadUserData() {
            const userId = currentUser.id.toString();
            const userRef = db.collection('users').doc(userId);
            const doc = await userRef.get();

            if (doc.exists) {
                userData = doc.data();
                console.log("Fetched fresh user data from Firebase.");
            } else {
                console.log("Creating new user in Firebase.");
                userData = {
                    id: userId,
                    username: currentUser.username || 'N/A',
                    firstName: currentUser.first_name,
                    coins: 0,
                    xp: 0,
                    level: 1,
                    farmingStartTime: null,
                    farmingDuration: 24 * 60 * 60 * 1000,
                    referrals: [],
                    completedTasks: [],
                    exchangedTotal: 0
                };
                await userRef.set(userData);
                // Check for referral on first-time user creation
                if (tg.initDataUnsafe.start_param) {
                    await handleReferral(tg.initDataUnsafe.start_param, userId);
                }
            }
             localStorage.setItem(`userData_${userId}`, JSON.stringify(userData));
            updateUI();
        }

        async function handleReferral(referrerId, newUserId) {
    if (referrerId === newUserId) {
        console.log("User tried to refer themselves.");
        return;
    }
    
    try {
        // Referrer exists check
        const referrerRef = db.collection('users').doc(referrerId);
        const referrerDoc = await referrerRef.get();
        if (!referrerDoc.exists) {
            console.log("Referrer not found!");
            return;
        }

        // Duplicate referral check
        const referrerData = referrerDoc.data();
        const existingReferrals = referrerData.referrals || [];
        if (existingReferrals.includes(newUserId)) {
            console.log("User was already referred by this referrer.");
            return;
        }

        // ‚úÖ REFERRAL AWARD KARO
        const referralReward = 100;
        const newCoins = (referrerData.coins || 0) + referralReward;
        const newReferrals = [...existingReferrals, newUserId];

        await referrerRef.update({
            coins: newCoins,
            referrals: newReferrals
        });
        
        console.log(`Awarded ${referralReward} coins to referrer ${referrerId}`);
        
    } catch (e) {
        console.error("Referral transaction failed: ", e);
    }
}
        function updateUI() {
            if (!userData) return;
            document.getElementById('coin-balance-container').innerText = `üí∞ ${Math.floor(userData.coins)}`;
            checkFarmingStatus();
        }

        async function syncUserData(updatedData) {
            Object.assign(userData, updatedData);
            localStorage.setItem(`userData_${currentUser.id}`, JSON.stringify(userData));
            const userRef = db.collection('users').doc(currentUser.id.toString());
            try {
                await userRef.update(updatedData);
                console.log("Synced data:", updatedData);
                updateUI(); // Refresh UI after every sync
            } catch (error) {
                console.error("Error syncing data:", error);
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => switchTab(e.currentTarget.dataset.tab));
            });
            document.getElementById('farm-button').addEventListener('click', handleFarmButtonClick);
            document.getElementById('task-type-input')?.addEventListener('change', (e) => {
    const keyContainer = document.getElementById('task-key-container');
    if (keyContainer) {
        keyContainer.classList.toggle('hidden', e.target.value !== 'youtube_video');
    }
});
}
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.nav-item[data-tab="${tabId}"]`).classList.add('active');

            if (tabId === 'tasks-tab') loadTasks();
            if (tabId === 'referral-tab') loadReferralData();
            if (tabId === 'exchange-tab') loadWithdrawalHistory();
            if (tabId === 'profile-tab') updateProfileTab();
        }

        // --- TASK LOGIC (NEW & DYNAMIC) --- //
        async function loadTasks() {
            const taskListEl = document.getElementById('task-list-dynamic');
            taskListEl.innerHTML = '<h4>Loading tasks...</h4>';

            const tasksSnapshot = await db.collection('tasks').get();
            taskListEl.innerHTML = '';

            // Add dynamic tasks from Firebase
            tasksSnapshot.forEach(doc => {
                const task = { id: doc.id, ...doc.data() };
                const isCompleted = userData.completedTasks?.includes(task.id);
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item';
                taskItem.innerHTML = `
                    <div class="task-info">
                        <h4>${task.name}</h4>
                        <p>Reward: ${task.reward} üí∞</p>
                    </div>
                    <button id="task-btn-${task.id}" ${isCompleted ? 'disabled' : ''}>
                        ${isCompleted ? 'Completed' : 'Go'}
                    </button>
                `;
                taskListEl.appendChild(taskItem);
                if (!isCompleted) {
                    document.getElementById(`task-btn-${task.id}`).onclick = () => handleTaskClick(task);
                }
            });

            // Add the static "Watch Ad" task
            const adTaskItem = document.createElement('div');
            adTaskItem.className = 'task-item';
            adTaskItem.innerHTML = `
                <div class="task-info">
                    <h4>üì∫ Watch Ad</h4>
                    <p>Reward: ${globalSettings.adReward || 10} üí∞</p>
                </div>
                <button onclick="watchAd()">Watch</button>
            `;
            taskListEl.appendChild(adTaskItem);
        }

                async function handleTaskClick(task) {
            const button = document.getElementById(`task-btn-${task.id}`);
            button.disabled = true;
            button.innerText = 'Checking...';

            switch (task.type) {
                case 'youtube_video':
                    // 1. First, redirect the user to the video
                    tg.showAlert("You will be redirected to YouTube. Watch the video to find the secret key, then return to the app.");
                    tg.openLink(task.link);
                    
                    // 2. After they return, prompt for the key. The timeout gives them time to switch apps.
                    setTimeout(() => {
                        const key = prompt("Please enter the secret key from the video you just watched.");
                        // We create an async function inside to use 'await'
                        (async () => {
                            if (key && key.trim().toLowerCase() === task.key.toLowerCase()) {
                                await grantTaskReward(task.id, task.reward);
                            } else {
                                tg.showAlert("Incorrect key, or you cancelled. Please try the task again.");
                                button.disabled = false;
                                button.innerText = 'Go';
                            }
                        })();
                    }, 2000); // Wait 2 seconds before showing the prompt
                    break;

                case 'join_channel':
                case 'join_group':
                    tg.openLink(task.link);
                    // IMPORTANT: True verification MUST happen on a server using Telegram's getChatMember API.
                    // This is a client-side simulation for demo purposes.
                    const verified = confirm("Please join the channel/group, then press OK to verify and claim your reward.");
                    if (verified) {
                         await grantTaskReward(task.id, task.reward);
                    } else {
                         button.disabled = false;
                         button.innerText = 'Go';
                    }
                    break;

                case 'visit_link':
                default:
                    tg.openLink(task.link);
                     await grantTaskReward(task.id, task.reward);
                    break;
            }
        }

        async function grantTaskReward(taskId, reward) {
            if (userData.completedTasks?.includes(taskId)) {
                tg.showAlert("You have already completed this task.");
                return;
            }
            const newCoins = (userData.coins || 0) + reward;
            const newCompletedTasks = [...(userData.completedTasks || []), taskId];
            await syncUserData({ coins: newCoins, completedTasks: newCompletedTasks });

            tg.showAlert(`Task completed! You earned ${reward} coins. üéâ`);
            const button = document.getElementById(`task-btn-${taskId}`);
            if (button) {
                button.innerText = 'Completed';
                button.disabled = true;
            }
        }

        window.watchAd = function() {
    const reward = globalSettings.adReward || 10;
    tg.showConfirm(`Watch an ad to earn ${reward} coins?`, async (confirmed) => {
        if (confirmed) {
            try {
                // Show the ad using the correct function name from your ad script
                if (typeof show_9966214 === 'function') {
                    await show_9966214('pop');
                } else if (typeof show_9966214 === 'function') {
                    await show_9966214('pop');
                } else {
                    // Simulate ad watching if ad function not available
                    tg.showPopup({
                        title: 'Watch Ad',
                        message: 'Please watch the ad video to completion...',
                        buttons: [{ type: 'ok', text: 'I Watched It' }]
                    });
                }
                
                const newCoins = (userData.coins || 0) + reward;
                await syncUserData({ coins: newCoins });
                tg.showAlert(`Ad watched! You earned ${reward} coins. üéâ`);
            } catch (e) {
                // If ad failed or user closed it early
                console.error('Ad failed or not completed:', e);
                tg.showAlert('Ad could not be completed. No reward given.');
            }
        }
    });
};

        // --- FARMING LOGIC --- //
        function handleFarmButtonClick() {
            const button = document.getElementById('farm-button');
            if (button.innerText.includes('Start')) {
                startFarming();
            } else if (button.innerText.includes('Claim')) {
                claimReward();
            }
        }

        async function startFarming() {
            await syncUserData({ farmingStartTime: Date.now() });
            checkFarmingStatus();
        }

        async function claimReward() {
            const farmRate = globalSettings.farmRate || 100;
            const elapsedMinutes = userData.farmingDuration / (60 * 1000);
            const coinsEarned = farmRate * elapsedMinutes;
            const newCoins = userData.coins + coinsEarned;
            const newXp = (userData.xp || 0) + 100;
            await syncUserData({ coins: newCoins, farmingStartTime: null, xp: newXp });
            tg.showAlert(`You claimed ${coinsEarned.toFixed(0)} coins!`);
            checkLevelUp(userData.xp, newXp);
            updateUI();
        }

        function checkFarmingStatus() {
            const button = document.getElementById('farm-button');
            const timerEl = document.getElementById('farm-timer');
            const progressEl = document.getElementById('farm-progress');
            if (farmInterval) clearInterval(farmInterval);

            if (userData.farmingStartTime) {
                const endTime = userData.farmingStartTime + userData.farmingDuration;
                farmInterval = setInterval(() => {
                    const now = Date.now();
                    const timeLeft = endTime - now;
                    if (timeLeft <= 0) {
                        clearInterval(farmInterval);
                        button.innerText = 'Claim Reward';
                        button.disabled = false;
                        timerEl.innerText = 'Farming complete!';
                        progressEl.style.width = '100%';
                        stopLeafAnimation();
                        return;
                    }
                    button.innerText = 'Farming...';
                    button.disabled = true;
                    startLeafAnimation();
                    const hours = Math.floor((timeLeft / (1000 * 60 * 60)) % 24);
                    const minutes = Math.floor((timeLeft / 1000 / 60) % 60);
                    const seconds = Math.floor((timeLeft / 1000) % 60);
                    timerEl.innerText = `Time left: ${hours}h ${minutes}m ${seconds}s`;
                    const progress = 100 - (timeLeft / userData.farmingDuration) * 100;
                    progressEl.style.width = `${progress}%`;
                }, 1000);
            } else {
                button.innerText = 'Start Farming';
                button.disabled = false;
                timerEl.innerText = 'Ready to farm!';
                progressEl.style.width = '0%';
                stopLeafAnimation();
            }
        }
        // --- WITHDRAWAL HISTORY FUNCTIONS --- //
async function loadWithdrawalHistory() { 
    try {
        console.log("Loading withdrawal history for user:", currentUser.id.toString());
        
        const querySnapshot = await db.collection('withdrawals')
            .where('userId', '==', currentUser.id.toString())
            .get();
        
        const listEl = document.getElementById('withdrawal-history-list');
        listEl.innerHTML = '';
        
        console.log("Found", querySnapshot.size, "withdrawals");
        
        if (querySnapshot.empty) { 
            listEl.innerHTML = '<p>No withdrawal history found.</p>'; 
            return; 
        } 
        
        querySnapshot.forEach(doc => { 
            const data = doc.data();
            console.log("Withdrawal data:", data);
            
            // Format timestamp properly
            let dateString = 'Unknown date';
            if (data.timestamp) {
                if (data.timestamp.toDate) {
                    dateString = data.timestamp.toDate().toLocaleDateString();
                } else if (data.timestamp instanceof Date) {
                    dateString = data.timestamp.toLocaleDateString();
                }
            }
            
            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `
                <div class="history-info">
                    <strong>${data.amount || 0} ${(data.method || 'unknown').toUpperCase()}</strong><br>
                    <small>To: ${data.address || 'N/A'}</small><br>
                    <small>Date: ${dateString} | Status: <span style="color: ${data.status === 'approved' ? 'green' : data.status === 'rejected' ? 'red' : 'orange'}">${data.status || 'pending'}</span></small>
                    ${data.adminNote ? `<br><small>Note: ${data.adminNote}</small>` : ''}
                </div>
            `;
            listEl.appendChild(item);
        });
    } catch (error) {
        console.error("Error loading withdrawal history:", error);
        document.getElementById('withdrawal-history-list').innerHTML = '<p>Error loading withdrawal history. Please try again.</p>';
    }
}

window.requestWithdrawal = async function() { 
    const amount = parseFloat(document.getElementById('withdrawal-amount').value);
    const method = document.getElementById('withdrawal-method').value;
    const address = document.getElementById('withdrawal-address').value.trim();
    
    if (isNaN(amount) || amount <= 0 || !address) {
        tg.showAlert("Please fill all withdrawal fields correctly.");
        return;
    }
    
    const userExchanged = (userData.exchangedTotal || 0);
    if (amount > userExchanged) {
        tg.showAlert(`Insufficient exchanged balance. You have ${userExchanged.toFixed(4)} available.`);
        return;
    }
    
    try {
        // Create withdrawal request
        const withdrawalData = {
            userId: currentUser.id.toString(),
            userName: currentUser.first_name || 'Unknown',
            amount: amount,
            method: method,
            address: address,
            status: 'pending',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('withdrawals').add(withdrawalData);
        
        // Update user's exchanged total
        const newExchangedTotal = userExchanged - amount;
        await syncUserData({ exchangedTotal: newExchangedTotal });
        
        tg.showAlert("Withdrawal request submitted successfully!");
        
        // Clear form
        document.getElementById('withdrawal-amount').value = '';
        document.getElementById('withdrawal-address').value = '';
        
        // Reload history
        loadWithdrawalHistory();
        
    } catch (error) {
        console.error("Error submitting withdrawal:", error);
        tg.showAlert("Error submitting withdrawal request. Please try again.");
    }
};
        // --- ANIMATIONS & OTHER TABS --- //
        let leafAnimationActive = false;
        function startLeafAnimation() { if (leafAnimationActive) return; leafAnimationActive = true; const container = document.getElementById('falling-leaves-container'); for (let i = 0; i < 15; i++) { const leaf = document.createElement('div'); leaf.className = 'leaf'; leaf.innerHTML = ['üçÇ', 'üçÅ'][Math.round(Math.random())]; leaf.style.left = `${Math.random() * 100}vw`; leaf.style.animationDuration = `${Math.random() * 3 + 4}s`; leaf.style.animationDelay = `${Math.random() * 5}s`; container.appendChild(leaf); } }
        function stopLeafAnimation() { leafAnimationActive = false; document.getElementById('falling-leaves-container').innerHTML = ''; }
        function checkLevelUp(oldXp, newXp) { const levelThreshold = (level) => Math.floor(100 * Math.pow(level, 1.5)); const currentLevelThreshold = levelThreshold(userData.level); if (newXp >= currentLevelThreshold) { const newLevel = userData.level + 1; syncUserData({ level: newLevel }); showLevelUpPopup(newLevel); } }
        function showLevelUpPopup(level) { const popup = document.getElementById('level-up-popup'); document.getElementById('new-level').innerText = `Level ${level}`; popup.classList.add('show'); createConfetti(); setTimeout(() => popup.classList.remove('show'), 4000); }
        function createConfetti() { const container = document.getElementById('confetti-container'); container.innerHTML = ''; for (let i = 0; i < 100; i++) { const confetti = document.createElement('div'); confetti.style.position = 'absolute'; confetti.style.width = `${Math.random() * 10 + 5}px`; confetti.style.height = confetti.style.width; confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`; confetti.style.left = `${Math.random() * 100}%`; confetti.style.top = `${-20}%`; confetti.style.animation = `confetti-fall ${Math.random() * 2 + 3}s linear ${Math.random() * 2}s forwards`; container.appendChild(confetti); } }
        const styleSheet = document.createElement("style"); styleSheet.type = "text/css"; styleSheet.innerText = `@keyframes confetti-fall { to { transform: translateY(150vh) rotate(${Math.random() * 720}deg); opacity: 0; } }`; document.head.appendChild(styleSheet);

        function updateProfileTab() { document.getElementById('profile-userid').innerText = userData.id; document.getElementById('profile-coins').innerText = Math.floor(userData.coins); document.getElementById('profile-exchanged').innerText = (userData.exchangedTotal || 0).toFixed(4); document.getElementById('profile-referrals').innerText = userData.referrals?.length || 0; document.getElementById('profile-level').innerText = userData.level; }

        window.convertCoins = async function() { const amount = parseInt(document.getElementById('convert-amount').value); if (isNaN(amount) || amount <= 0) { tg.showAlert("Enter a valid coin amount."); return; } if (amount > (userData.coins || 0)) { tg.showAlert("You do not have enough coins."); return; } const rate = globalSettings.conversionRate || 1000; const converted = amount / rate; await syncUserData({ coins: (userData.coins || 0) - amount, exchangedTotal: (userData.exchangedTotal || 0) + converted }); tg.showAlert(`Converted ${amount} coins into ${converted.toFixed(4)} units.`); updateUI(); };

        function loadReferralData() { const linkInput = document.getElementById('referral-link'); linkInput.value = `https://t.me/Farmingnew_Bot?start=${currentUser.id}`; const displayEl = document.getElementById('referral-history-list'); const referralCount = userData.referrals?.length || 0; if (referralCount === 0) { displayEl.innerHTML = `<p>No referrals yet. Share your link to earn 100 coins per referral!</p>`; } else { displayEl.innerHTML = `<p>You have referred <strong>${referralCount} users</strong> and earned <strong>${referralCount * 100} coins</strong>!</p><div style="margin-top: 10px;"><strong>Referral IDs:</strong><br>${userData.referrals.map(id => `‚Ä¢ ${id}`).join('<br>')}</div>`; } }

        window.copyReferralLink = async function() { const linkInput = document.getElementById('referral-link'); try { await navigator.clipboard.writeText(linkInput.value); tg.showAlert('Referral link copied!'); } catch (err) { linkInput.select(); document.execCommand('copy'); tg.showAlert('Referral link copied!'); } };
    
        // --- ADMIN PANEL LOGIC (EXPANDED) --- //
        window.handleAdminLogin = function() {
            const email = document.getElementById('admin-email').value;
            const pass = document.getElementById('admin-password').value;
            if (email === 'malakzaikhan@gmail.com' && pass === 'malakzai123') {
                document.getElementById('admin-login-screen').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                loadAdminData();
            } else {
                document.getElementById('admin-login-error').innerText = "Invalid credentials.";
            }
        }
        async function loadAdminData() {
    // Bind the event listener for the task type dropdown
    document.getElementById('task-type-input').addEventListener('change', (e) => {
        const keyContainer = document.getElementById('task-key-container');
        keyContainer.classList.toggle('hidden', e.target.value !== 'youtube_video');
    });

            // Load Settings
            const settings = (await db.collection('settings').doc('global').get()).data() || {};
            document.getElementById('setting-farm-rate').value = settings.farmRate || 100;
            document.getElementById('setting-conversion-rate').value = settings.conversionRate || 1000;
            document.getElementById('setting-ad-reward').value = settings.adReward || 50;
            
            // Load Withdrawals
            const wSnapshot = await db.collection('withdrawals').where('status', '==', 'pending').get();
            const wTableBody = document.querySelector('#withdrawal-requests-table tbody');
            wTableBody.innerHTML = '';
            wSnapshot.forEach(doc => {
                const data = doc.data();
                const row = wTableBody.insertRow();
                row.innerHTML = `<td>${data.userId}</td><td>${data.amount}</td><td>${data.method}</td><td>${data.address}</td><td>${data.status}</td><td><button onclick="updateWithdrawalStatus('${doc.id}', 'approved')">Approve</button><button onclick="updateWithdrawalStatus('${doc.id}', 'rejected')" style="background:var(--danger-color)">Reject</button></td>`;
            });

            // Load Tasks and Dashboard Stats
            loadAdminTasks();
            loadAdminDashboardStats();
        }
        async function loadAdminDashboardStats() {
            const usersSnapshot = await db.collection('users').get();
            const withdrawalsSnapshot = await db.collection('withdrawals').where('status', '==', 'pending').get();
            let totalCoins = 0;
            usersSnapshot.forEach(doc => { totalCoins += doc.data().coins || 0; });
            document.getElementById('stats-total-users').innerText = usersSnapshot.size;
            document.getElementById('stats-total-coins').innerText = Math.floor(totalCoins);
            document.getElementById('stats-pending-withdrawals').innerText = withdrawalsSnapshot.size;
        }
        async function loadAdminTasks() {
            const tasksSnapshot = await db.collection('tasks').get();
            const tableBody = document.querySelector('#tasks-table tbody');
            tableBody.innerHTML = '';
            tasksSnapshot.forEach(doc => {
                const task = { id: doc.id, ...doc.data() };
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${task.name}</td>
                    <td>${task.reward}</td>
                    <td>${task.type}</td>
                    <td>
                        <button onclick='editAdminTask("${task.id}", ${JSON.stringify(task)})'>Edit</button>
                        <button onclick='deleteAdminTask("${task.id}")' style="background:var(--danger-color)">Delete</button>
                    </td>
                `;
            });
        }
        window.editAdminTask = function(id, taskData) {
            document.getElementById('task-id-input').value = id;
            document.getElementById('task-name-input').value = taskData.name;
            document.getElementById('task-reward-input').value = taskData.reward;
            document.getElementById('task-type-input').value = taskData.type;
            document.getElementById('task-link-input').value = taskData.link;
            document.getElementById('task-key-input').value = taskData.key || '';
            document.getElementById('task-type-input').dispatchEvent(new Event('change')); // Trigger visibility check for key
            window.scrollTo(0, 0); // Scroll to top to see the form
        };
        window.deleteAdminTask = async function(id) {
            if (confirm("Are you sure you want to delete this task?")) {
                await db.collection('tasks').doc(id).delete();
                alert("Task deleted.");
                loadAdminTasks();
            }
        };
                window.saveAdminTask = async function() {
            const taskId = document.getElementById('task-id-input').value;
            const taskData = {
                name: document.getElementById('task-name-input').value,
                reward: parseInt(document.getElementById('task-reward-input').value),
                type: document.getElementById('task-type-input').value,
                link: document.getElementById('task-link-input').value,
                key: document.getElementById('task-key-input').value.trim() // key ko trim kar dein
            };
            
            if (!taskData.name || !taskData.reward || !taskData.link) {
                alert("Please fill Name, Reward, and Link fields.");
                return;
            }

            // YEH NAYA LOGIC HAI
            // Agar task type YouTube hai, to check karo ki key khali to nahi hai
            if (taskData.type === 'youtube_video' && !taskData.key) {
                alert("For YouTube tasks, the secret key is required.");
                return; // function ko yahin rok do
            }

            // Agar task type YouTube nahi hai, to key ko save mat karo
            if (taskData.type !== 'youtube_video') {
                delete taskData.key; // taskData object se key ko ‡§π‡§ü‡§æ do
            }
            
            try {
                if (taskId) {
                    await db.collection('tasks').doc(taskId).update(taskData);
                    alert("Task updated!");
                } else {
                    await db.collection('tasks').add(taskData);
                    alert("Task added!");
                }
            } catch (error) {
                console.error("Error saving task: ", error);
                alert("Could not save the task. See console for details.");
            }
            
            // Form ko reset karo
            document.getElementById('task-id-input').value = '';
            document.getElementById('task-name-input').value = '';
            document.getElementById('task-reward-input').value = '';
            document.getElementById('task-link-input').value = '';
            document.getElementById('task-key-input').value = '';
            document.getElementById('task-key-container').classList.add('hidden');
            
            loadAdminTasks();
        };

        window.saveAdminSettings = async function() {
            const settings = {
                farmRate: parseInt(document.getElementById('setting-farm-rate').value),
                conversionRate: parseInt(document.getElementById('setting-conversion-rate').value),
                adReward: parseInt(document.getElementById('setting-ad-reward').value)
            };
            await db.collection('settings').doc('global').set(settings, { merge: true });
            alert("Settings saved!");
        };
        window.updateWithdrawalStatus = async function(docId, status) {
            const reason = prompt(`Enter reason for ${status} (optional):`);
            await db.collection('withdrawals').doc(docId).update({ status: status, adminNote: reason || '' });
            alert(`Withdrawal ${status}. User will be notified (requires backend bot).`);
            loadAdminData();
        };
        window.sendBroadcast = function() {
            alert("Broadcast feature requires a backend bot to send messages to all users.");
        }

        // --- START THE APP --- //
        initializeApp();
    });
</script>
    <script src='https://libtl.com/sdk.js' data-zone='9966214' data-sdk='show_9966214'></script> 
</body>
</html> 
